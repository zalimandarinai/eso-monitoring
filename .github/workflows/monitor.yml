name: ESO Monitoring

on:
  workflow_dispatch:
    inputs:
      ESO_ID:
        description: 'ESO object ID'
        required: true
        default: '362'
  schedule:
    - cron: '0 6 * * *'  # kasdien 06:00 UTC

permissions:
  contents: write    # reikalinga, kad GITHUB_TOKEN turÄ—tÅ³ teisÄ™ daryti git commitâ€™us

jobs:
  check-eso:
    runs-on: ubuntu-latest
    env:
      ESO_ID: ${{ github.event.inputs.ESO_ID }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          persist-credentials: true

      - name: Download ESO result
        run: |
          curl -s "https://www.eso.lt/web/namams/gaminantis-vartotojas/laisvos-galios-pasitikrinimas/${ESO_ID}" \
            > result.html

      - name: Compare and notify
        run: |
          # IÅ¡traukime tik vidÅ³ tarp <div class="result-block">â€¦</div>
          STATUS=$(grep -oP '(?<=<div class="result-block">)[\s\S]*?(?=</div>)' result.html \
                   | tr '\n' ' ' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          if [ -z "$STATUS" ]; then
            echo "::warning::Nepavyko iÅ¡gauti ESO statuso â€“ puslapis atsiuntÄ— HTML be result-block."
            exit 0
          fi

          # Jei nÄ—ra last.html arba pasikeitÄ— â€“ siÅ³sti ir commit'inti
          if [ ! -f last.txt ] || ! cmp -s <(printf '%s' "$STATUS") last.txt; then
            printf '%s' "$STATUS" > last.txt
            curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              --data chat_id="${TELEGRAM_CHAT_ID}" \
              --data text="ğŸ”” ESO statusas pasikeitÄ—: $STATUS"
          else
            echo "No change â€“ nieko nesiunÄiam."
          fi

      - name: Commit snapshot if changed
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'Update ESO snapshot'
          file_pattern: last.txt
          github_token: ${{ secrets.GITHUB_TOKEN }}
