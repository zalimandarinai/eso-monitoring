# .github/workflows/monitor.yml
name: ESO Monitoring

# Reikalingos teisƒós ra≈°ymui
permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    # kasdien 06:00 UTC (08:00 Lietuvos laiku)
    - cron: '0 6 * * *'

jobs:
  check-eso:
    runs-on: ubuntu-latest
    # u≈ætikrina, kad GITHUB_TOKEN turi ra≈°ymo teises
    permissions:
      contents: write

    env:
      ESO_ID: 362
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID:  ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          # leid≈æia automati≈°kai ra≈°yti atgal
          persist-credentials: true

      - name: Download ESO result
        run: |
          URL="https://www.eso.lt/web/namams/gaminantis-vartotojas/laisvos-galios-pasitikrinimas/${ESO_ID}"
          curl -s "$URL" -o result.html

      - name: Extract status text
        run: |
          grep -oP '(?<=<div class="result-block">)[\s\S]*?(?=</div>)' result.html \
            | sed 's/<[^>]*>//g' \
            | sed -e 's/^[[:space:]]*//' \
            > result.txt

      - name: Compare and notify
        run: |
          if [ ! -f last.txt ] || ! cmp -s result.txt last.txt; then
            MSG=$(< result.txt)
            curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              --data chat_id="$TELEGRAM_CHAT_ID" \
              --data text="üîî ESO statusas pasikeitƒó: $MSG"
          else
            echo "No change ‚Äì nieko nesiunƒçiam."
          fi

      - name: Commit new snapshot
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Update ESO snapshot
          file_pattern: result.txt
