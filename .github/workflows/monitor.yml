name: ESO Monitoring

# PaleidÅ¾iam kasdien 06:00 UTC (08:00 Lietuvos laiku) ir rankiniu bÅ«du
on:
  schedule:
    - cron:  '0 6 * * *'
  workflow_dispatch:

# Suteikiam workflow teisÄ™ raÅ¡yti repo (tam, kad auto-commit veiktÅ³)
permissions:
  contents: write

env:
  ESO_ID:             7117568
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID:   ${{ secrets.TELEGRAM_CHAT_ID }}

jobs:
  check-eso:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download ESO page
        run: |
          URL="https://www.eso.lt/web/namams/gamintojams/vartotojams/laisvos-galios-pasitikr..."${ESO_ID}
          curl -s "$URL" > result.html

      - name: Extract status text
        run: |
          sed -n '/<div class="result-block">/,/<\/div>/p' result.html \
            | sed 's/<[^>]*>//g' \
            | tr -d '\r' \
            > result.txt

      - name: Compare with last snapshot
        id: compare
        run: |
          if [ -f last.txt ] && cmp -s result.txt last.txt; then
            echo "::set-output name=changed::false"
          else
            echo "::set-output name=changed::true"
            mv result.txt last.txt
          fi

      - name: Send Telegram alert
        if: steps.compare.outputs.changed == 'true'
        run: |
          MSG=$(< last.txt)
          curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="ðŸ”” ESO statusas pasikeitÄ—:\n${MSG}"

      - name: Commit new snapshot
        if: steps.compare.outputs.changed == 'true'
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Update ESO snapshot
          file_pattern: last.txt
