name: ESO Monitoring

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # kasdien 06:00 UTC (08:00 Lietuvos laiku)

jobs:
  check-eso:
    runs-on: ubuntu-latest

    env:
      ESO_ID: 71177586
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download ESO result
        run: |
          URL="https://www.eso.lt/web/namams/gaminantis-vartotojas/laisvos-galios-pasitikrinimas/362?objectCode=$ESO_ID"
          curl -s "$URL" > result.html

      - name: Compare and notify
        run: |
          # Palyginame su paskutine versija, jei nesikeite â€“ iÅ¡einame
          if [ -f last.html ] && cmp -s last.html result.html; then
            echo "No change â€“ rezultatas tas pats"
            exit 0
          fi

          # Atnaujiname snapshot
          mv result.html last.html

          # IÅ¡traukiame tik tekstÄ… tarp <div class="result-block">â€¦</div>
          MSG=$(grep -oP '(?<=<div class="result-block">).+?(?=</div>)' last.html \
            | sed 's/<[^>]*>//g' \
            | tr -d '\n')

          # SiunÄiame Ä¯ Telegram
          curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            --data chat_id="${TELEGRAM_CHAT_ID}" \
            --data-urlencode text="ğŸ”” ESO statusas pasikeitÄ—: ${MSG}"

