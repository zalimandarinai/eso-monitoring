name: ESO Monitoring

# rankinis paleidimas + kasdien 06:00 UTC
on:
  workflow_dispatch:
    inputs:
      ESO_ID:
        description: 'ESO object ID'
        required: true
        default: '362'
  schedule:
    - cron: '0 6 * * *'  # kasdien 06:00 UTC (08:00 Lietuvos laiku)

jobs:
  check-eso:
    runs-on: ubuntu-latest
    env:
      ESO_ID: ${{ github.event.inputs.ESO_ID }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Download ESO result
        run: |
          curl -s "https://www.eso.lt/web/namams/gaminantis-vartotojas/laisvos-galios-pasitikrinimas/${ESO_ID}" > result.html

      - name: Compare and notify
        run: |
          # jeigu dar nÄ—ra senos nuotraukos, arba ji skiriasi nuo naujos
          if [ ! -f last.html ] || ! cmp -s result.html last.html; then
            # atnaujinam snapshot ir siunÄiam Telegram Å¾inutÄ™
            mv result.html last.html
            MSG=$(sed -n 's/.*<div class="result-block">//; s#</div>.*##; p' last.html | tr '\n' ' ')
            curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              --data chat_id="${TELEGRAM_CHAT_ID}" \
              --data text="ğŸ”” ESO statusas pasikeitÄ—: $MSG"
          else
            echo "No change â€“ nieko nesiunÄiam"
          fi

      - name: Commit snapshot if changed
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'Update ESO snapshot'
          file_pattern: last.html
