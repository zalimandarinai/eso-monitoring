name: ESO Monitoring

# Leid≈æia paleisti rankiniu b≈´du bei turi ƒØvestƒØ ESO objekto ID
on:
  workflow_dispatch:
    inputs:
      ESO_ID:
        description: 'ESO object ID'
        required: true

jobs:
  check-eso:
    runs-on: ubuntu-latest
    env:
      # Paima vartotojo ƒØvestƒÖ ID
      ESO_ID: ${{ github.event.inputs.ESO_ID }}
      # Telegram bot token bei chat ID, nustatyk juos repo secrets
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Ensure last.txt exists
        run: |
          if [ ! -f last.txt ]; then
            echo "" > last.txt
          fi

      - name: Download ESO result
        run: |
          URL="https://www.eso.lt/web/namams/gaminantis-vartotojas/laisvos-galios-pasitikrinimas/${ESO_ID}"
          curl -sL "$URL" > result.html

      - name: Dump raw HTML for debugging
        run: |
          echo "=== RESULT.HTML BEGIN ==="
          sed -n '1,200p' result.html
          echo "=== RESULT.HTML END ==="

      - name: Extract status text
        run: |
          # I≈°kerpa viduje <div class="result-block">‚Ä¶</div>, pa≈°alina HTML tag‚Äôus
          grep -oP '(?s)(?<=<div class="result-block">).*?(?=</div>)' result.html \
            | sed 's/<[^>]*>//g' \
            | tr -d '\n' \
            | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' \
            > result.txt
          echo "üîç Extracted status:"
          cat result.txt

      - name: Compare and notify
        run: |
          if cmp -s result.txt last.txt; then
            echo "No change ‚Äì nothing to do"
          else
            mv result.txt last.txt
            MSG=$(cat last.txt)
            curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              --data chat_id="${TELEGRAM_CHAT_ID}" \
              --data text="üîî ESO statusas pasikeitƒó: $MSG"
          fi

      - name: Commit snapshot if changed
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: 'Update ESO snapshot'
          file_pattern: last.txt
